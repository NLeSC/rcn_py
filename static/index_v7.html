<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://neo4j-documentation.github.io/developer-resources/language-guides/assets/css/main.css">
    <title>Neo4j RCN</title>
</head>

<body>
<div id="graph">
</div>
<div role="navigation" class="navbar navbar-default navbar-static-top">
    <div class="container">
        <div class="row">
            <div class="col-sm-6 col-md-6">
                <ul class="nav navbar-nav">
                    <li>
                        <form class="navbar-form" id="search">
                            <div class="form-group">
                            <label for="keyword">Keyword:</label>
                            <input type="text" name="keyword" id="keyword" placeholder="Deep learning" class="form-control" minlength="3" maxlength="20">
                            <br>
                            <label for="year">Year:</label>
                            <input type="year" name="year" id="year" placeholder=2022 class="form-control">
                            <br>
                            <button class="btn btn-default" type="submit" id="submit-btn">Search</button>
                            </div>
                        </form>
                    </li>
                </ul>
            </div>

            <div class="navbar-header col-sm-6 col-md-6">
                <!-- <div class="logo-well">
                    <a href="https://neo4j.com/developer/get-started">
                    <img src="https://neo4j-documentation.github.io/developer-resources/language-guides/assets/img/logo-white.svg" alt="Neo4j World's Leading Graph Database" id="logo">
                    </a>
                </div> -->
                <div class="navbar-brand">
                    <div class="brand">Research Collaboration Network</div>
                </div>
            </div>

            <div class="col-sm-6 col-md-6">
                <ul class="nav navbar-nav">
                    <li>
                        <form class="navbar-form" id="orcid_search">
                            <div class="form-group">
                            <label for="orcid">Or search for authors by ORCID:</label>
                            <input type="text" name="orcid" id="orcid" placeholder="0000-0002-5025-7862" class="form-control" minlength="19" maxlength="19">
                            <br>
                            <button class="btn btn-default" type="submit" id="orcid-submit-btn">Search</button>
                            </div>
                        </form>
                    </li>
                </ul>
            </div>
        </div>
    </div>
</div>

<div class="row justify-content-end">
    <div class="col-md-3">
        <div class="panel panel-default">
            <div class="panel-heading" id="title">Details</div>
            <div class="row">
                <div class="col-md-8 col-sm-8">
                    <h6>Node information</h6>
                    <ul id="info">
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<style type="text/css">
    .node { stroke: #222; stroke-width: 1.5px; }
    .node.author { fill: #BBB; }
    .node.publication { fill: #788cc0; }
    .node.author_highlight { fill: #ee977c; }
    .node.first_coauthor { fill: #ffca7f; }
    .node.second_coauthor { fill: #fff493; }
    .node.first_pub { fill: #8ac7ffe1; }
    .node.second_pub { fill: #98979a; }
    .link { stroke: #999; stroke-opacity: .6; stroke-width: 1px; }
</style>


<script type="text/javascript" src="//code.jquery.com/jquery-1.11.0.min.js"></script>
<script src="https://d3js.org/d3.v6.min.js"></script>


<script type="text/javascript">
    // ####################### initial #######################
    const width = window.innerWidth, height =  window.innerHeight;
    const radius = Math.min(width, height) / 2 - 50;
    // const width = 960, height =  600;
    const force = d3.forceSimulation()
            .force("charge", d3.forceManyBody().strength(-5))
            .force("link", d3.forceLink().id(function(d) { return d.id; }).distance(50))
            .force("center", d3.forceCenter().x(width / 2).y(height / 2).strength(0.5))
            .force("collision", d3.forceCollide().radius(function(d) { return d.r + 5; }).iterations(1));

    // A temporary translate for the current position
    var svgTranslate = [0, 0];
    var curTranslate = [0, 0];
    var zoom_transform = [0, 0];
    var svgScale = 1;
    let isDragging = false;
    let isDragged = false;
    var dx = 0, dy = 0,
        zx = 0, zy = 0;

    // Define the SVG canvas
    var svg = d3.select("#graph").append("svg")
            .attr("width", width).attr("height", height)
            .attr("position", "absolute")
            .attr("viewBox", `0 0 ${width} ${height}`)
            .attr("pointer-events", "all")
            .call(d3.drag()
                .on("start", canvas_dragstarted)
                .on("drag", canvas_dragged)
                .on("end", canvas_dragended))
            .call(d3.zoom()
                .on("start", zoomstarted)
                .on("zoom", zoomed)
                .on("end", zoomended))
            // .append("g")
            ;


    // Define the drag behavior
    function zoomstarted(event) {
        // Get current position of network after drag event
        svgTranslate[0] = dx;
        svgTranslate[1] = dy;
        zoom_transform[0] = event.transform.x;
        zoom_transform[1] = event.transform.y;

        d3.select(this).attr("zoomstartx", svgTranslate[0]);
        d3.select(this).attr("zoomstarty", svgTranslate[1]);
    }
    function zoomed(event) {
        if(isDragged) {
            zx = event.transform.x + svgTranslate[0] - zoom_transform[0];
            zy = event.transform.y + svgTranslate[1] - zoom_transform[1];
        }
        else {
            zx = event.transform.x + svgTranslate[0];
            zy = event.transform.y + svgTranslate[1];
        }
        svgScale = event.transform.k;

        d3.select(this).attr("aaa", event.transform.x- zoom_transform[0]);
        d3.select(this).attr("bbb", event.transform.y- zoom_transform[1]);
        d3.select(this).attr("drag", isDragged);
        // d3.select(this).attr("scale", svgScale);
        d3.select(this).attr("zx", zx);
        d3.select(this).attr("zy", zy);

        svg.attr("transform", `translate(${zx},${zy})  scale(${svgScale})`);

        curTranslate[0] = zx;
        curTranslate[1] = zy;
    }
    function zoomended(event) {
        isDragged = false;
        zoom_transform[0] = event.transform.x;
        zoom_transform[1] = event.transform.y;
    }
  

    function canvas_dragstarted(event) {
        isDragging = true;
        svgTranslate[0] = event.x;
        svgTranslate[1] = event.y;
    }
    function canvas_dragged(event) {
        // Calculate the amount of movement
        // svgTranslate[0] = event.x;
        // svgTranslate[1] = event.y;

        if(isDragging) {
            
            dx = curTranslate[0] + event.x - svgTranslate[0];
            dy = curTranslate[1] + event.y - svgTranslate[1];

            d3.select(this).attr("dx", dx);
            d3.select(this).attr("dy", dy);
            // Update the transform of the canvas
            svg.attr("transform", `translate(${dx},${dy}) scale(${svgScale})`);
            
        }
    }
    function canvas_dragended(event){
        // Update the starting position for the next drag event
        curTranslate[0] = dx;
        curTranslate[1] = dy;
        isDragging = false;
        isDragged = true;
    }


    function node_dragstarted(event) {
        if (!event.active) force.alphaTarget(0.3).restart();
        event.subject.fx = event.subject.x;
        event.subject.fy = event.subject.y;
    }

    function node_dragged(event) {
        event.subject.fx = event.x;
        event.subject.fy = event.y;
    }
          
    function node_dragended(event) {
        if (!event.active) force.alphaTarget(0);
        event.subject.fx = null;
        event.subject.fy = null;
    }

    
   


    // ############# Initial network ##############
    d3.json("/graph").then(function(graph) {
        

        // const force = d3.forceSimulation(node)
        // .force("charge", d3.forceManyBody().strength(-50))
        // .force("link", d3.forceLink(graph.links).distance(100))
        // .force("center", d3.forceCenter(width/2, height/2));
        var pack = d3.pack()
                .size([width, height])
                .padding(1)
                (d3.hierarchy({children: graph.nodes})
                .sum(function(d) { return d.size }));

        // update the radius of each node based on the pack layout
        graph.nodes.forEach(function(d) { d.r = d.size ? pack.r(d) : 5; });

        force.nodes(graph.nodes)
            .force("link", d3.forceLink(graph.links))

        

        const link = svg.selectAll(".link")
                    .data(graph.links).enter()
                    .append("line").attr("class", "link");

        const node = svg.selectAll(".node")
                    .data(graph.nodes).enter()
                    .append("circle")
                    .attr("class", function (d) { return "node "+d.label; })
                    .attr("r", 3)
                    .call(d3.drag()
                        .on("start", node_dragstarted)
                        .on("drag", node_dragged)
                        .on("end", node_dragended))
                    ;

        // html title attribute
        node.append("title")
                    .text(function (d) { return d.title; });


        // force feed algo ticks
        force.on("tick", function() {
            svg.selectAll('.link')
            .attr("x1", function (d) { return d.source.x })
            .attr("y1", function (d) { return d.source.y })
            .attr("x2", function (d) { return d.target.x })
            .attr("y2", function (d) { return d.target.y })
            
            svg.selectAll('.node')
            .attr("cx", function (d) { return d.x })
            .attr("cy", function (d) { return d.y })
            
        });

        
    });
        



    // ####################### function #######################
    $(document).ready(function(){
        // ################### Refresh ####################
        function refresh(){
            d3.select("#graph").selectAll("*").remove();
            svgTranslate = [0, 0];
            // Define the SVG canvas
            svg = d3.select("#graph").append("svg")
                    .attr("width", "100%").attr("height", "100%")
                    .attr("position", "absolute")
                    .attr("viewBox", `0 0 ${width} ${height}`)
                    .attr("pointer-events", "all")
                    ;

            // Define the zoom behavior
            zoom = d3.behavior.zoom()
                        .center([0,0])
                        .scaleExtent([0.1, 10])
                        .on("zoomstart", zoomstarted)
                        .on("zoom", zoomed)
                        .on("zoomend", zoomended);


            // Define the drag behavior
            drag = d3.behavior.drag()
                        .on("dragstart", dragstarted)
                        .on("drag", canvas_dragged)
                        .on("dragend", dragended);

            // Select the SVG element and apply the zoom and drag behaviors
            svg.call(zoom).call(drag);
            return svg;
        }

        // ################### keyword search ###################
        const form = document.getElementById('search');
        form.addEventListener('submit', function(event) {
            // prevent the form from submitting and refreshing the page
            event.preventDefault(); 
            // call your function here
            field_search();
        });

        function field_search(){

            var form = $('#search');
            var year = form.find("input[name='year']").val();
            var keyword = form.find("input[name=keyword]").val();
            svg = refresh();
            svgTranslate = [0, 0];

            d3.json("/search?keyword=" + encodeURIComponent(keyword) + "&year=" + encodeURIComponent(year),
                function (error, graph) {
                    if (error) return;
                    if (!graph || graph.length == 0) return;

                    // d3.select("#graph").selectAll("*").remove();
                    // var svg = d3.select("#graph").append("svg")
                    //         .attr("width", "100%").attr("height", "100%")
                    //         .attr("pointer-events", "all");

                    force.nodes(graph.nodes).links(graph.links).start();

                    const link = svg.selectAll(".link")
                                    .data(graph.links).enter()
                                    .append("line").attr("class", "link");

                    const node = svg.selectAll(".node")
                                    .data(graph.nodes).enter()
                                    .append("circle")
                                    .attr("class", function (d) { return "node "+d.label })
                                    .attr("r", 10)
                                    .call(force.drag()
                                        .on("dragstart", dragstarted)
                                        .on("drag", node_dragged)
                                        .on("dragend", dragended)
                                    );

                    // html title attribute
                    node.append("title")
                        .text(function (d) { return d.title; })

                    // force feed algo ticks
                    force.on("tick", function() {
                        link.attr("x1", function(d) { return d.source.x; })
                            .attr("y1", function(d) { return d.source.y; })
                            .attr("x2", function(d) { return d.target.x; })
                            .attr("y2", function(d) { return d.target.y; });

                        node.attr("cx", function(d) { return d.x; })
                            .attr("cy", function(d) { return d.y; });
                    });
                });
            return false;
        }
        


        // ################### ORCID search ######################
        const form_orcid = document.getElementById('orcid_search');
        form_orcid.addEventListener('submit', function(event) {
            event.preventDefault(); // prevent the form from submitting and refreshing the page
            // call your function here
            orcid_search();
        });

        function orcid_search(){
            // Prevent default form submission action
            // event.preventDefault();   
            var form = $('#orcid_search');
            var orcid = form.find("input[name='orcid']").val();
      
            svg = refresh();
            svgTranslate = [0, 0];

            d3.json("/orcid_search?orcid=" + encodeURIComponent(orcid),
                function (error, graph) {
                    if (error) return;
                    if (!graph || graph.length == 0) return;

                    force.nodes(graph.nodes).links(graph.links).start();

                    const link = svg.selectAll(".link")
                                    .data(graph.links).enter()
                                    .append("line").attr("class", "link");

                    const node = svg.selectAll(".node")
                                    .data(graph.nodes).enter()
                                    .append("circle")
                                    .attr("class", function (d) {
                                            return "node "+d.label;
                                        })
                                    .attr("r", 10)
                                    .call(force.drag()
                                        .on("dragstart", dragstarted)
                                        .on("drag", node_dragged)
                                        .on("dragend", dragended)
                                    );

                    // html title attribute
                    node.append("title")
                        .text(function (d) { return d.title; })

                    // force feed algo ticks
                    force.on("tick", function() {
                        link.attr("x1", function(d) { return d.source.x; })
                            .attr("y1", function(d) { return d.source.y; })
                            .attr("x2", function(d) { return d.target.x; })
                            .attr("y2", function(d) { return d.target.y; });

                        node.attr("cx", function(d) { return d.x; })
                            .attr("cy", function(d) { return d.y; });
                    });
                });
            return false;
        }
    })
    
</script>

</body>
</html>
